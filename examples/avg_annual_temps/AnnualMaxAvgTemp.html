<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>ACIS examples, Average Annual Max Temp</title>
		<script type="text/javascript" src="http://d3js.org/d3.v3.js"></script>
		<style type="text/css">
		body {
			font: 14px sans-serif;
		}	
		.axis path,
		.axis line {
			fill: none;
			stroke: black;
			shape-rendering: crispEdges;
		}

		</style>
	</head>
	<body>
		<script src="../../build/build.js"></script>
		<script type="text/javascript">
			var request = require('superagent');
			var holdingArray;
			
			var params = {
			  "sid":"304174",
                "sdate":"por","edate":"por",
                "elems":[{"name":"maxt","interval":"yly","duration":"yly","reduce":"mean","maxmissing":15}]
              };
			  
			var paramsmin = {
			  "sid":"304174",
                "sdate":"por","edate":"por",
                "elems":[{"name":"mint","interval":"yly","duration":"yly","reduce":"mean","maxmissing":15}]
              };
			
			request
				.post('http://data.rcc-acis.org/StnData', params)
				.end(function(res){
					if (res.status == 200) {
						if (res.body.error === undefined) {
							var myArray = res.body.data;
							
							for(var i = myArray.length - 1; i >= 0; i--) {
								if(myArray[i][1] == 'M') {
									myArray.splice(i, 1);
								}
							}
							holdingArray = myArray;
							//build_plot(myArray)
						}
					else console.log('invalid request %s', res.body.error)
					} 
					else {
						console.log('failed request %s',res.status)
					}
				});
				request
				.post('http://data.rcc-acis.org/StnData', paramsmin)
				.end(function(res){
					if (res.status == 200) {
						if (res.body.error === undefined) {
							var myArray = res.body.data;
							
							for(var i = myArray.length - 1; i >= 0; i--) {
								if(myArray[i][1] == 'M') {
									myArray.splice(i, 1);
								}
							}
							newArray = holdingArray.concat(myArray);
							build_plot(newArray)
						}
					else console.log('invalid request %s', res.body.error)
					} 
					else {
						console.log('failed request %s',res.status)
					}
				});
				
				
				
			
				
			var build_plot = function (dataset) {	
			var margin = {top: 20, right: 20, bottom: 30, left: 50},
                width = 600 - margin.left - margin.right,
                height = 300 - margin.top - margin.bottom;
			//Create scale functions
			var parseDate = d3.time.format("%Y").parse;
			
			var xScale = d3.time.scale()
						.range([0, width]);

			var yScale = d3.scale.linear()
						.range([height, 0]);
								 
						//Define X axis
            var xAxis = d3.svg.axis()
                .scale(xScale)
                .ticks(5)
                .orient("bottom");
				
			//Define Y axis
            var yAxis = d3.svg.axis()
                .scale(yScale)
                .orient("left");

			//Create SVG element
			var svg = d3.select("body")
				.append("svg")
					.attr("width", width + margin.left + margin.right)
					.attr("height", height + margin.top + margin.bottom)
				.append("g")
					.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
			
			dataset.forEach(function(d) {
              d[0] = parseDate(d[0]);
			  d[1] == +d[1];
            });
			
			xScale.domain(d3.extent(dataset, function(d) { return d[0]; }));
			yScale.domain(d3.extent(dataset, function(d) { return d[1]; }));
			
			
			
			svg.selectAll("circle")
			   .data(dataset)
			   .enter()
			   .append("circle")
			   .attr("cx", function(d) {
			   		return xScale(d[0]);
			   })
			   .attr("cy", function(d) {
			   		return yScale(d[1]);
			   })
			   .attr("r", 3)
			   //.style("fill","blue")
			   .style("fill", function(d){
					if (dataset.indexOf(d) >= (dataset.length / 2))
						return "blue"
					else
						return "red"
			   });

			svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);
 
            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis)
				.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .text("Annual Avg Temp");
			}
		</script>
	</body>
</html>